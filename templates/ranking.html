<!DOCTYPE html>
<html>
<head>
  <title>ë­í‚¹</title>
  <style>
    body { font-family: sans-serif; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    .top-margin { background-color: #d0f0ff; }
    .top-winrate { background-color: #e0ffe0; }
    .worst-margin { background-color: #ffe0e0; }
    .worst-winrate { background-color: #fff4cc; }
    .slider-label { font-size: 1.2em; font-weight: bold; margin-right: 10px; }
    .slider-wrapper { margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
    .slider-wrapper input[type=range] { width: 400px; height: 40px; }
    .slider-wrapper input[type=number] { width: 60px; height: 30px; font-size: 1em; }
  </style>
  <script>
    function updateSlider(val) {
      document.getElementById("sliderVal").innerText = val;
      document.getElementById("sliderInput").value = val;
      document.getElementById("sliderNumber").value = val;
      const url = new URL(window.location.href);
      url.searchParams.set("min_games", val);
      window.location.href = url.toString();
    }
    function updateFromBox(val) {
      document.getElementById("sliderInput").value = val;
      updateSlider(val);
    }
    window.addEventListener("DOMContentLoaded", () => {
      const val = parseInt("{{ min_games|default(5) }}");
      const slider = document.getElementById("sliderInput");
      const number = document.getElementById("sliderNumber");
      const display = document.getElementById("sliderVal");
      if (slider && number && display) {
        slider.value = val;
        number.value = val;
        display.innerText = val;
      }
    });
  </script>
</head>
<body>
  <h1>ğŸ€ Stepback ë­í‚¹</h1>
  <nav>
    <a href="/">ë‚ ì§œë³„ ê²½ê¸°</a> |
    <a href="/player">ê°œì¸ê¸°ë¡</a> |
    <a href="/ranking">ë­í‚¹</a> |
    <a href="/input">ì…ë ¥</a>
  </nav>
  <hr>

  <form id="sliderForm" method="get" action="/ranking">
    <div class="slider-wrapper">
      <label class="slider-label">ìµœì†Œ ê²½ê¸°ìˆ˜:</label>
      <input type="range" id="sliderInput" name="min_games" min="1" max="100" oninput="updateSlider(this.value)">
      <input type="number" id="sliderNumber" min="1" max="100" onchange="updateFromBox(this.value)">
      <span id="sliderVal"></span>
    </div>
  </form>

  {% for size in range(1, 6) %}
    <h2>{{ size }}ì¸ ì¡°í•©</h2>
    <table>
      <tr>
        <th>ìˆœìœ„</th>
        <th>ì¡°í•©</th>
        <th>ê²½ê¸°ìˆ˜</th>
        <th>ë§ˆì§„</th>
        <th>ìŠ¹ë¥ </th>
        <th>êµ¬ë¶„</th>
      </tr>
      {% set rows = ranking | selectattr("size", "equalto", size) | list %}
      {% if rows|length == 0 %}
        <tr><td colspan="6">ë°ì´í„° ì—†ìŒ</td></tr>
      {% else %}
        {% set sorted_rows = rows | sort(attribute='type') %}
        {% set previous_type = "" %}
        {% set rank = namespace(value=1) %}
        {% for row in sorted_rows %}
          <tr class="{% if row.type == 'TOP_MARGIN' %}top-margin{% elif row.type == 'TOP_WINRATE' %}top-winrate{% elif row.type == 'WORST_MARGIN' %}worst-margin{% elif row.type == 'WORST_WINRATE' %}worst-winrate{% endif %}">
            <td>{{ rank.value }}</td>
            <td>{{ row.players }}</td>
            <td>{{ row.games }}</td>
            <td>{{ row.get('margin', 0)|round(1) }}</td>
            <td>{{ row.get('winrate', 0) }}%</td>
            <td>
              {% if row.type == 'TOP_MARGIN' %}ë§ˆì§„ TOP
              {% elif row.type == 'TOP_WINRATE' %}ìŠ¹ë¥  TOP
              {% elif row.type == 'WORST_MARGIN' %}ë§ˆì§„ WORST
              {% elif row.type == 'WORST_WINRATE' %}ìŠ¹ë¥  WORST
              {% endif %}
            </td>
          </tr>
          {% set previous_type = row.type %}
          {% set rank.value = rank.value + 1 %}
        {% endfor %}
      {% endif %}
    </table>
  {% endfor %}
</body>
</html>
